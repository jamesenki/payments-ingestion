name: Deploy Function App Code

on:
  push:
    branches:
      - main
    paths:
      - 'src/function_app/**'
      - 'requirements.txt'
      - '.github/workflows/function-app-deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
      version:
        description: 'Version tag (optional, defaults to commit SHA)'
        required: false
        type: string

permissions:
  contents: read
  id-token: write

jobs:
  deploy-function-app:
    name: Deploy Function App to ${{ github.event.inputs.environment || 'dev' }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python_version: '3.11'

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: |
            {
              "clientId": "${{ secrets[format('{0}_AZURE_CLIENT_ID', (github.event.inputs.environment || 'dev') == 'production' && 'PROD' || upper(github.event.inputs.environment || 'dev'))] }}",
              "clientSecret": "${{ secrets[format('{0}_AZURE_CLIENT_SECRET', (github.event.inputs.environment || 'dev') == 'production' && 'PROD' || upper(github.event.inputs.environment || 'dev'))] }}",
              "subscriptionId": "${{ secrets[format('{0}_AZURE_SUBSCRIPTION_ID', (github.event.inputs.environment || 'dev') == 'production' && 'PROD' || upper(github.event.inputs.environment || 'dev'))] }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      - name: Get Function App Info
        id: get-func-info
        run: |
          ENV=${{ github.event.inputs.environment || 'dev' }}
          RG_NAME="payments-ingestion-${ENV}-rg"
          FUNC_APP_NAME="payments-ingestion-${ENV}-func-eus"
          
          # Verify Function App exists
          FUNC_EXISTS=$(az functionapp show \
            --resource-group $RG_NAME \
            --name $FUNC_APP_NAME \
            --query "name" -o tsv 2>/dev/null || echo "")
          
          if [ -z "$FUNC_EXISTS" ]; then
            echo "❌ Function App not found: $FUNC_APP_NAME"
            echo "Please deploy infrastructure first using terraform-deploy workflow"
            exit 1
          fi
          
          echo "FUNCTION_APP_NAME=$FUNC_APP_NAME" >> $GITHUB_OUTPUT
          echo "RESOURCE_GROUP=$RG_NAME" >> $GITHUB_OUTPUT
          echo "✅ Function App found: $FUNC_APP_NAME"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create deployment package
        run: |
          # Create deployment directory
          mkdir -p deploy_package
          
          # Copy function app code
          cp -r src/function_app deploy_package/
          
          # Copy requirements
          cp requirements.txt deploy_package/
          
          # Copy function.json
          cp src/function_app/function.json deploy_package/
          
          # Create host.json if it doesn't exist
          if [ ! -f deploy_package/host.json ]; then
            cat > deploy_package/host.json <<EOF
          {
            "version": "2.0",
            "logging": {
              "applicationInsights": {
                "samplingSettings": {
                  "isEnabled": true,
                  "maxTelemetryItemsPerSecond": 20
                }
              }
            },
            "extensionBundle": {
              "id": "Microsoft.Azure.Functions.ExtensionBundle",
              "version": "[4.*, 5.0.0)"
            }
          }
          EOF
          fi
          
          # Create .python_packages directory structure
          mkdir -p deploy_package/.python_packages/lib/python3.11/site-packages
          
          # Copy installed packages (excluding system packages)
          pip install -r requirements.txt --target deploy_package/.python_packages/lib/python3.11/site-packages
          
          # Create deployment zip
          cd deploy_package
          zip -r ../function-app-deployment.zip . -x "*.pyc" "__pycache__/*" "*.git*"
          cd ..
          
          echo "✅ Deployment package created: function-app-deployment.zip"
          ls -lh function-app-deployment.zip

      - name: Deploy to Function App
        run: |
          FUNC_APP_NAME="${{ steps.get-func-info.outputs.FUNCTION_APP_NAME }}"
          RG_NAME="${{ steps.get-func-info.outputs.RESOURCE_GROUP }}"
          VERSION="${{ github.event.inputs.version || github.sha }}"
          
          echo "Deploying to Function App: $FUNC_APP_NAME"
          echo "Version: $VERSION"
          
          # Deploy using zipdeploy
          az functionapp deployment source config-zip \
            --resource-group $RG_NAME \
            --name $FUNC_APP_NAME \
            --src function-app-deployment.zip
          
          echo "✅ Function App code deployed successfully"

      - name: Verify Function App Deployment
        run: |
          FUNC_APP_NAME="${{ steps.get-func-info.outputs.FUNCTION_APP_NAME }}"
          RG_NAME="${{ steps.get-func-info.outputs.RESOURCE_GROUP }}"
          
          echo "Verifying Function App deployment..."
          
          # Check Function App status
          STATUS=$(az functionapp show \
            --resource-group $RG_NAME \
            --name $FUNC_APP_NAME \
            --query "state" -o tsv)
          
          if [ "$STATUS" != "Running" ]; then
            echo "⚠️  Function App status: $STATUS"
          else
            echo "✅ Function App is running"
          fi
          
          # List functions
          echo ""
          echo "Deployed functions:"
          az functionapp function list \
            --resource-group $RG_NAME \
            --name $FUNC_APP_NAME \
            --query "[].name" -o table || echo "No functions found (may need to check manually)"

      - name: Create Deployment Tag
        if: github.event.inputs.environment == 'production'
        run: |
          VERSION="${{ github.event.inputs.version || github.sha }}"
          TAG="function-app-v${VERSION:0:7}"
          
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a "$TAG" -m "Function App deployment: ${{ github.event.inputs.environment }} - $VERSION"
          git push origin "$TAG" || echo "Tag already exists or push failed"

      - name: Upload Deployment Artifact
        uses: actions/upload-artifact@v3
        with:
          name: function-app-deployment-${{ github.event.inputs.environment || 'dev' }}
          path: function-app-deployment.zip
          retention-days: 7

  notify-success:
    name: Notify Deployment Success
    needs: deploy-function-app
    if: success()
    runs-on: ubuntu-latest
    steps:
      - name: Success Notification
        run: |
          echo "✅ Function App code deployment completed successfully!"
          echo "Environment: ${{ github.event.inputs.environment || 'dev' }}"
          echo "Deployed by: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"
          echo "Timestamp: $(date)"

  notify-failure:
    name: Notify Deployment Failure
    needs: deploy-function-app
    if: failure()
    runs-on: ubuntu-latest
    steps:
      - name: Failure Notification
        run: |
          echo "❌ Function App code deployment failed!"
          echo "Environment: ${{ github.event.inputs.environment || 'dev' }}"
          echo "Please check the logs and consider rollback if necessary."
          exit 1

